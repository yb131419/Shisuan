<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>å½¥å½¬ğŸŒ¿è©¦ç®—ç³»çµ±</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
:root{
  --bg:#0f0f0f;--panel-bg:#1a1a1a;--text:#e0e0e0;--accent:#00d1b2;
  --highlight:#40c4ff;--error:#ff5252;--btn-grey:#3a3a3a;--warning:#ff9800;
  --super:#d4af37;--vip:#00bfa5;--grad-primary:linear-gradient(135deg,#1a2a6c,#b21f1f,#fdbb2d);
  --grad-secondary:linear-gradient(145deg,#2d2d2d,#1f1f1f);--shadow:0 8px 32px rgba(0,0,0,0.4);
  --loader:#00d1b2;--vip-username:linear-gradient(135deg,#00bfa5,#00ffde);
  --super-username:linear-gradient(135deg,#d4af37,#ffff00);--yellow:#ffd700;
  --btn-shadow:0 4px 15px rgba(0,0,0,0.2);--btn-hover-shadow:0 6px 20px rgba(0,0,0,0.3);
  --btn-active-shadow:0 2px 8px rgba(0,0,0,0.2);--btn-transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
  --btn-radius:8px;--btn-padding:8px 14px;
  /* ä¿®æ”¹ï¼šæ—¶é•¿é€‰é¡¹æ”¹ä¸ºç™½è‰²ä¸»é¢˜ */
  --period-active:linear-gradient(145deg,#ffffff,#f0f0f0);
  --period-hover:linear-gradient(145deg,#ffffff,#e8e8e8);
  --period-border:#ffffff;--period-shadow:0 0 15px rgba(255,255,255,0.5);
  --period-text:#000;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  background:var(--bg);color:var(--text);font-family:'Segoe UI','Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;
  padding:10px;line-height:1.5;min-height:100vh;display:flex;flex-direction:column;align-items:center;
}
#authContainer{position:fixed;top:0;left:0;width:100%;height:100vh;display:flex;justify-content:center;align-items:center;z-index:9999;background:rgba(0,0,0,0.8);}
#authLoading{
  width:100%;max-width:400px;background:var(--grad-secondary);border-radius:16px;padding:40px 25px;text-align:center;
  box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.05);transition:all 0.5s ease;
}
/* ä¿®æ”¹ï¼šç™»å½•çŠ¶æ€æ å¯éšè—ï¼Œå¢åŠ å…³é—­æŒ‰é’®å’Œè¿‡æ¸¡æ•ˆæœ */
#authStatusBar{
  position:sticky;top:10px;z-index:999;background:var(--grad-secondary);padding:12px 18px;border-radius:12px;margin-bottom:20px;
  font-size:14px;text-align:center;border:1px solid rgba(0,209,178,0.3);box-shadow:0 4px 16px rgba(0,0,0,0.3);
  display:none;width:100%;max-width:600px;transition:all 0.3s ease;
}
#authStatusBar .close-status{
  position:absolute;top:5px;right:10px;width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,0.1);
  color:#fff;border:none;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;
  transition:var(--btn-transition);
}
#authStatusBar .close-status:hover{
  background:rgba(255,255,255,0.2);transform:scale(1.1);
}
.loader{
  width:50px;height:50px;border:3px solid rgba(255,255,255,0.1);border-top-color:var(--loader);border-radius:50%;
  animation:spin 1s linear infinite,pulse 2s ease-in-out infinite alternate;margin:0 auto 20px;
}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes pulse{from{box-shadow:0 0 15px rgba(0,209,178,0.3);}to{box-shadow:0 0 25px rgba(0,209,178,0.6);}}
#authLoading h3{margin:0 0 8px 0;font-size:1.2rem;color:var(--highlight);font-weight:600;}
#authLoading p{margin:0;font-size:0.95rem;color:#bbb;line-height:1.6;}
.super-admin{color:var(--super);font-weight:bold;}
.vip-admin{color:var(--vip);font-weight:bold;}
.normal{color:var(--highlight);font-weight:bold;}
.expired{color:var(--error);font-weight:bold;}
.remaining-days-yellow{color:var(--yellow);font-weight:bold;text-shadow:0 0 5px rgba(255,215,0,0.5);}
.super-admin-username,.vip-admin-username{
  background-clip:text;-webkit-background-clip:text;color:transparent;font-weight:bold;
  text-shadow:0 0 8px rgba(255,255,255,0.3);
}
.super-admin-username{background-image:var(--super-username);}
.vip-admin-username{background-image:var(--vip-username);}
#captureArea{
  background:linear-gradient(145deg,#1c1c1c,#141414);box-shadow:inset 0 1px 2px rgba(255,255,255,0.05),0 4px 20px rgba(0,0,0,0.6);
  color:var(--text);padding:15px 10px;border-radius:12px;margin-bottom:15px;overflow-x:auto;display:none;width:100%;max-width:600px;
}
#captureArea h2{
  text-align:center;font-size:1.8rem;font-weight:bold;color:#fff;margin:0 0 15px 0;padding:10px 0;
  line-height:1.3;width:100%;
}
.period-options{display:flex;justify-content:center;gap:10px;margin:10px 0 15px;flex-wrap:wrap;}
/* ä¿®æ”¹ï¼šæ—¶é•¿é€‰é¡¹ç™½è‰²é«˜çº§è´¨æ„Ÿæ ·å¼ */
.period-box{
  border:1px solid #e0e0e0;border-radius:8px;padding:8px 15px;color:#e0e0e0;font-size:14px;cursor:pointer;
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden;background:transparent;
  font-weight:500;
}
.period-box:hover{
  border-color:var(--period-border);background:var(--period-hover);color:var(--period-text);
  transform:translateY(-2px);box-shadow:var(--period-shadow);
  background-image:linear-gradient(145deg,#ffffff,#f8f8f8);
}
.period-box.active{
  border-color:var(--period-border);background:var(--period-active);color:var(--period-text);
  font-weight:bold;box-shadow:var(--period-shadow);
  background-image:linear-gradient(145deg,#ffffff,#e8e8e8);
  transform:translateY(-1px);
}
.period-box.active::after{
  content:'';position:absolute;bottom:2px;right:2px;width:12px;height:12px;
  background:var(--period-text);border-radius:50%;opacity:0.8;
}
@media (min-width:768px){
  #captureArea h2{font-size:2.2rem;}
  .period-box{font-size:16px;padding:10px 20px;border-radius:10px;}
}
.userInputs{display:flex;flex-direction:column;gap:10px;margin-bottom:15px;}
.userInputs .row{display:flex;gap:10px;width:100%;}
.userInputs label{flex:1;display:flex;flex-direction:column;font-size:14px;color:#bbb;}
.userInputs label span{text-align:center;margin-bottom:4px;font-size:15px;}
.userInputs input{
  padding:10px;font-size:16px;background:#333;color:var(--text);border:none;
  border-radius:6px;width:100%;text-align:center;
}
.calculator-container{display:flex;gap:5px;}
.btn{
  border:1px solid rgba(255,255,255,0.8);border-radius:var(--btn-radius);padding:var(--btn-padding);
  font-size:13px;font-weight:600;color:#fff;cursor:pointer;box-shadow:var(--btn-shadow);
  transition:var(--btn-transition);display:inline-flex;align-items:center;justify-content:center;
  gap:6px;text-decoration:none;-webkit-tap-highlight-color:transparent;position:relative;overflow:hidden;
}
.btn::before{
  content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);
  transition:all 0.6s ease;
}
.btn:hover::before{left:100%;}
.btn:hover{transform:translateY(-1px);box-shadow:var(--btn-hover-shadow);}
.btn:active{transform:translateY(1px);box-shadow:var(--btn-active-shadow);}
.btn:disabled{opacity:0.7;cursor:not-allowed;transform:none;box-shadow:var(--btn-shadow);}
.btn-primary{background:linear-gradient(145deg,#00bfa5,#009e8a);}
.btn-primary:hover{background:linear-gradient(145deg,#00ccb2,#00a98e);}
.btn-warning{background:linear-gradient(145deg,#ff9800,#e68900);}
.btn-warning:hover{background:linear-gradient(145deg,#ffa726,#f59e0b);}
.btn-grey{background:linear-gradient(145deg,#3a3a3a,#2a2a2a);}
.btn-grey:hover{background:linear-gradient(145deg,#4a4a4a,#3a3a3a);}
.btn-danger{background:linear-gradient(145deg,#ff5252,#d32f2f);}
.btn-danger:hover{background:linear-gradient(145deg,#ff6b6b,#e53935);}
.btn-sm{padding:6px 10px;font-size:11px;border-radius:5px;}
.btn-md{padding:7px 12px;font-size:12px;border-radius:6px;}
.btn-lg{padding:9px 18px;font-size:14px;border-radius:8px;width:100%;}
#resetCalculatorBtn{
  width:35px;height:35px;border-radius:5px;background:var(--btn-grey);color:#fff;
  border:1px solid rgba(255,255,255,0.8);cursor:pointer;font-size:14px;
  display:flex;align-items:center;justify-content:center;transition:var(--btn-transition);
}
#resetCalculatorBtn:hover{background:#555;transform:scale(1.05);}
#resetCalculatorBtn:active{transform:scale(0.95);}
#addBtn{min-width:180px!important;padding:16px 24px!important;font-size:18px!important;font-weight:700!important;border-radius:12px!important;height:auto!important;}
#nameInput option{padding:12px 10px;line-height:1.6;font-size:16px;height:auto;white-space:normal;}
#reportTable{
  width:100%;min-width:300px;border-collapse:collapse;font-size:12px;border-radius:10px;
  overflow:hidden;background:#f9fafb;color:#374151;margin:0 auto;
}
#reportTable th:nth-child(1),#reportTable td:nth-child(1){width:22%;}
#reportTable th:nth-child(2),#reportTable td:nth-child(2){width:10%;}
#reportTable th:nth-child(3),#reportTable td:nth-child(3){width:12%;}
#reportTable th:nth-child(4),#reportTable td:nth-child(4){width:12%;}
#reportTable th:nth-child(5),#reportTable td:nth-child(5){width:16%;}
#reportTable th:nth-child(6),#reportTable td:nth-child(6){width:16%;}
#reportTable th:nth-child(7),#reportTable td:nth-child(7){width:12%;}
#reportTable th,#reportTable td{
  border:1px solid #d1d5db;padding:6px 4px;text-align:center;white-space:nowrap;
  transition:all 0.3s ease;
}
#reportTable th:nth-child(2),#reportTable td:nth-child(2),.qtySelect{font-size:16px!important;font-weight:bold!important;}
#reportTable td:nth-child(3),#reportTable td:nth-child(4),#reportTable td:nth-child(5),#reportTable td:nth-child(6){font-weight:500;text-align:center!important;}
@media (min-width:768px){
  #reportTable th,#reportTable td{padding:8px 5px;font-size:14px;}
  #reportTable th:nth-child(2),#reportTable td:nth-child(2),.qtySelect,#qtyInput{font-size:18px!important;}
}
#reportTable thead{background:linear-gradient(90deg,#2b6cb0,#3182ce);color:#fff;font-weight:600;}
#reportTable tbody tr:nth-child(odd){background:#f3f4f6;}
#reportTable tbody tr:nth-child(even){background:#e5e7eb;}
#reportTable tbody tr:hover{background:#1e88e5;color:#fff;font-weight:bold;transform:scale(1.01);}
.deleteBtn{
  writing-mode:vertical-rl;text-orientation:upright;background:var(--error);
  border:1px solid rgba(255,255,255,0.8);color:#fff;border-radius:4px;padding:2px;
  cursor:pointer;font-size:11px;display:inline-block;margin:0 auto;
  transition:var(--btn-transition);
}
.deleteBtn:hover{transform:scale(1.1);box-shadow:0 0 8px rgba(255,82,82,0.5);}
.deleteBtn:active{transform:scale(0.95);}
.deleteBtn:disabled{opacity:0.7;cursor:not-allowed;transform:none;}
.summaryBox{text-align:center;margin-top:13px;font-size:1rem;font-weight:bold;color:var(--highlight);line-height:1.6;}
.summaryBox .extra{display:block;font-size:0.9rem;color:var(--accent);margin-top:4px;}
.summaryBox .done{color:#4caf50;font-weight:bold;}
#totalPriceCellDup,#totalPvCellDup,#pvDiff,#pvDiff2{display:inline-block;min-width:60px;text-align:center;}
#inputArea{display:flex;flex-direction:column;gap:10px;margin:15px 0 30px 0;display:none;width:100%;max-width:600px;}
@media (min-width:576px){#inputArea{flex-direction:row;align-items:center;}}
#nameInput,#qtyInput{
  background:#2c2c2c;color:var(--text);flex:1;text-align:center;padding:12px 10px;
  font-size:16px;border-radius:6px;border:none;
}
#qtyInput{font-size:18px!important;font-weight:bold;}
#exportBtn,#shareToLineBtn,#nativeShareBtn,#clearImageBtn,#resetReportBtn{flex:1;min-width:90px;margin:0;}
#previewImage{display:none;width:100%!important;max-width:600px;margin:15px auto!important;border:2px solid #888;border-radius:10px;image-rendering:-webkit-optimize-contrast;image-rendering:pixelated;}
#shareToLineBtn,#nativeShareBtn,#clearImageBtn{display:none;}
#buyerInput,#calculatorDisplay{
  background:#f9fafb;border:1.5px solid #d1d5db;color:#374151;border-radius:8px;
  padding:10px 12px;font-size:16px;transition:border-color 0.3s ease,box-shadow 0.3s ease;
  width:100%;font-weight:500;
}
@media (min-width:768px){#buyerInput,#calculatorDisplay{font-size:18px;}}
#buyerInput:focus{
  border-color:#2563eb;box-shadow:0 0 8px 2px rgba(37,99,235,0.3);
  outline:none;background:#fff;
}
#calculatorDisplay{background:#e9ecef;cursor:default;}
#buyerInput::placeholder{color:#9ca3af;font-weight:400;text-align:center;}
.toast{
  position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:var(--grad-secondary);
  color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.4);
  opacity:0;transition:opacity 0.5s ease,transform 0.5s ease;z-index:1000;text-align:center;
  min-width:200px;font-size:15px;border:1px solid rgba(255,255,255,0.1);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-10px);}
.toast.error{background:linear-gradient(145deg,#4a0000,#2a0000);border-color:rgba(255,82,82,0.3);}
.toast.warning{background:linear-gradient(145deg,#4a3200,#2a1e00);border-color:rgba(255,152,0,0.3);}
.payment-options{display:flex;justify-content:center;gap:15px;margin-top:8px;color:#fff;font-size:1.1rem;flex-wrap:wrap;}
.payment-options label{display:flex;align-items:center;gap:10px;color:#fff;font-weight:500;}
.payment-options input[type="checkbox"]{width:24px;height:24px;cursor:pointer;}
@media print{
  body{background:#fff;color:#000;}
  #authContainer,#authLoading,#authStatusBar,#inputArea,#addBtn,#exportBtn,#shareToLineBtn,#clearImageBtn,#nativeShareBtn,#resetCalculatorBtn,#resetReportBtn{display:none!important;}
  #captureArea{box-shadow:none;background:#fff;color:#000;display:block!important;}
  #reportTable th{background:#ccc!important;color:#000!important;}
  .deleteBtn{display:none!important;}
  .summaryBox{color:#000!important;}
  #reportTable td,#reportTable th{text-align:center!important;}
  #reportTable th:nth-child(2),#reportTable td:nth-child(2){font-size:16px!important;font-weight:bold!important;}
}
.spacer{height:80px;}
@media (max-width:360px){
  .userInputs .row{gap:5px;}
  .userInputs label{font-size:13px;}
  .userInputs input{font-size:15px;padding:8px;}
  #reportTable{font-size:11px;}
  #reportTable th:nth-child(2),#reportTable td:nth-child(2),.qtySelect,#qtyInput{font-size:15px!important;}
  .payment-options{font-size:1rem;}
  #authStatusBar{font-size:12px;}
  #authLoading{padding:30px 20px;}
  .loader{width:40px;height:40px;}
  #addBtn{min-width:150px!important;padding:14px 20px!important;font-size:16px!important;}
  .period-box{padding:6px 10px;font-size:12px;}
}
#error-message{
  display:none;background:linear-gradient(145deg,#4a0000,#2a0000);border:1px solid rgba(255,82,82,0.3);
  color:#fef2f2;padding:20px;border-radius:16px;margin:20px auto;max-width:400px;text-align:center;
  box-shadow:var(--shadow);
}
#error-message #error-content{margin-bottom:15px;}
#error-message button{
  background:linear-gradient(145deg,#ff5252,#d32f2f);color:#fff;border:none;border:1px solid rgba(255,255,255,0.8);
  padding:8px 16px;border-radius:6px;cursor:pointer;margin-top:10px;font-weight:500;transition:var(--btn-transition);
}
#error-message button:hover{
  background:linear-gradient(145deg,#ff6b6b,#e53935);transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(255,82,82,0.3);
}
.button-group{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0;display:none;width:100%;max-width:600px;}
</style>
</head>
<body>
<div id="authContainer">
  <div id="error-message">
    <div id="error-content"></div>
  </div>
  <div id="authLoading">
    <div class="loader"></div>
    <h3>æ­£åœ¨é©—è­‰ç”¨æˆ¶æ¬Šé™</h3>
    <p>è«‹ç¨å€™...</p>
  </div>
</div>
<!-- ä¿®æ”¹ï¼šå¢åŠ å…³é—­æŒ‰é’® -->
<div id="authStatusBar" style="display: none;">
  <button class="close-status" title="éš±è—ç‹€æ…‹æ¬„">âœ•</button>
</div>
<div id="captureArea">
  <h2>
    ğŸŒ¿ åº·åœ’è©¦ç®—å ±è¡¨
    <div class="payment-options">
      <label><input type="checkbox" id="cashOption" /> ğŸ’µ ç¾é‡‘</label>
      <label><input type="checkbox" id="cardOption" /> ğŸ’³ åˆ·å¡</label>
    </div>
    <div class="period-options">
      <div class="period-box">ä¸€å€‹æœˆ</div>
      <div class="period-box">ä¸‰å€‹æœˆ</div>
      <div class="period-box">åŠå¹´</div>
      <div class="period-box">ä¸€å¹´</div>
    </div>
  </h2>
  <div class="userInputs">  
    <div class="row">
      <label>
        <span>è³¼è²·è€…ï¼š</span>
        <input type="text" placeholder="è¼¸å…¥è³¼è²·è€…" id="buyerInput" />
      </label>
      <label>
        <span>è©¦ç®—è€…ï¼š</span>
        <div class="calculator-container">
          <input type="text" id="calculatorDisplay" readonly />
          <button id="resetCalculatorBtn" title="é‡ç½®è©¦ç®—è€…åç¨±">â†º</button>
        </div>
      </label>
    </div>
  </div>
  <table id="reportTable" aria-label="è©¦ç®—å ±è¡¨">
    <thead>
      <tr>
        <th>å“é …åç¨±</th>
        <th>æ•¸é‡</th>
        <th>å–®åƒ¹</th>
        <th>PV</th>
        <th>å°è¨ˆé‡‘é¡</th>
        <th>å°è¨ˆPV</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
  </table>
  <div class="summaryBox" aria-live="polite">
    ç¸½ é‡‘é¡ï¼š<span id="totalPriceCellDup">0</span>ï½œç¸½ PVï¼š<span id="totalPvCellDup">0</span>
    <span class="extra">è· 11.2è¬ PVï¼š<span id="pvDiff">112000</span> <span id="pvMessage1"></span></span>
    <span class="extra">è· 22.0è¬ PVï¼š<span id="pvDiff2">220000</span> <span id="pvMessage2"></span></span>
  </div>
</div>
<img id="previewImage" alt="é è¦½åŒ¯å‡ºåœ–ç‰‡" />
<div class="button-group">
  <button id="exportBtn" class="btn btn-primary">ğŸ“¤ å ±è¡¨è½‰åœ–ç‰‡</button>
  <button id="shareToLineBtn" class="btn btn-primary">ğŸ“± å®‰å“åˆ†äº«</button>
  <button id="nativeShareBtn" class="btn btn-primary">ğŸ“± åˆ†äº«åœ–ç‰‡</button>
  <button id="clearImageBtn" class="btn btn-grey">âŒ æ¸…é™¤åœ–ç‰‡</button>
  <button id="resetReportBtn" class="btn btn-warning">ğŸ”„ é‡ç½®å ±è¡¨</button>
</div>
<div id="toast" class="toast">âœ… åœ–ç‰‡å·²ä¸Šå‚³</div>
<div id="inputArea">
  <select id="nameInput"></select>
  <select id="qtyInput"></select>
  <button id="addBtn" class="btn btn-primary btn-lg">â• æ–°å¢å“é …</button>
</div>
<div class="spacer"></div>
<script>
const API_URL="https://script.google.com/macros/s/AKfycbxMK8aSmldCGKmXffbL5XU6IGuLbaKS1VABe9LuWXSF6hg2NtGLGZxS8fT-jqiFKy8_/exec";
const IMGBB_API_KEY="5be146133d1fa6ded66878aade98880f";
const LIFF_ID="2008578880-zlK2U8dQ";
const JSONP_TIMEOUT=15000;
const PERMANENT_EXPIRY_DATE="9999/12/31";
const TARGET_PV112=112000;
const TARGET_PV220=220000;
const MAX_NORMAL_USER_USAGE=10;
const DEDUCT_INTERVAL=180000;
let products=[],selectedProds=[],lineName='',userInfo=null,authStatus=null,isDeleting=false;
let lastDeductTime=parseInt(localStorage.getItem('lastDeductTime'))||0;
let userUsageRecord=JSON.parse(localStorage.getItem('userUsageRecord'))||{};
const els={
  nameInput:document.getElementById("nameInput"),
  qtyInput:document.getElementById("qtyInput"),
  addBtn:document.getElementById("addBtn"),
  reportBody:document.getElementById("reportBody"),
  totalPriceCellDup:document.getElementById("totalPriceCellDup"),
  totalPvCellDup:document.getElementById("totalPvCellDup"),
  pvDiff:document.getElementById("pvDiff"),
  pvDiff2:document.getElementById("pvDiff2"),
  pvMessage1:document.getElementById("pvMessage1"),
  pvMessage2:document.getElementById("pvMessage2"),
  exportBtn:document.getElementById("exportBtn"),
  previewImage:document.getElementById("previewImage"),
  shareToLineBtn:document.getElementById("shareToLineBtn"),
  nativeShareBtn:document.getElementById("nativeShareBtn"),
  clearImageBtn:document.getElementById("clearImageBtn"),
  resetReportBtn:document.getElementById("resetReportBtn"),
  buyerInput:document.getElementById("buyerInput"),
  calculatorDisplay:document.getElementById("calculatorDisplay"),
  resetCalculatorBtn:document.getElementById("resetCalculatorBtn"),
  toast:document.getElementById("toast"),
  authLoading:document.getElementById("authLoading"),
  authStatusBar:document.getElementById("authStatusBar"),
  captureArea:document.getElementById("captureArea"),
  inputArea:document.getElementById("inputArea"),
  buttonGroup:document.querySelector(".button-group"),
  errorMessage:document.getElementById("error-message"),
  errorContent:document.getElementById("error-content"),
  authLoadingTitle:document.querySelector("#authLoading h3"),
  authLoadingDesc:document.querySelector("#authLoading p"),
  reportTable:document.getElementById("reportTable")
};

// å·¥å…·å‡½æ•¸ï¼šç²å–ç•¶å¤©æ—¥æœŸï¼ˆYYYYMMDDï¼‰
const getTodayDate=()=>{
  const d=new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
};

// å·¥å…·å‡½æ•¸ï¼šæª¢æŸ¥æ˜¯å¦æ˜¯ç•¶å¤©çš„æœ‰æ•ˆé©—è­‰
const isTodayValidAuth=(userId)=>{
  const authCache=JSON.parse(localStorage.getItem(`authCache_${userId}`))||{};
  return authCache.date===getTodayDate()&&authCache.data;
};

// å·¥å…·å‡½æ•¸ï¼šä¿å­˜ç•¶å¤©é©—è­‰ç·©å­˜
const saveTodayAuthCache=(userId,authData)=>{
  localStorage.setItem(`authCache_${userId}`,JSON.stringify({
    date:getTodayDate(),
    data:authData
  }));
};

// åˆå§‹åŒ–æ•¸é‡é¸æ“‡æ¡†
for(let i=1;i<=99;i++){
  const option=document.createElement("option");
  option.value=i;
  option.textContent=i;
  els.qtyInput.appendChild(option);
}

// æ–°å¢æ™‚é•·é¸é …é»æ“Šäº‹ä»¶
document.querySelectorAll('.period-box').forEach(box=>{
  box.addEventListener('click',function(){
    document.querySelectorAll('.period-box').forEach(b=>b.classList.remove('active'));
    this.classList.add('active');
  });
});

// ä¿®æ”¹ï¼šæ·»åŠ çŠ¶æ€æ å…³é—­æŒ‰é’®äº‹ä»¶
document.querySelector('.close-status').addEventListener('click',function(){
  els.authStatusBar.style.opacity='0';
  setTimeout(()=>{
    els.authStatusBar.style.display='none';
    els.authStatusBar.style.opacity='1';
  },300);
});

// äº‹ä»¶ç¶å®š
els.nameInput.addEventListener('change',function(){checkHerbalNewMember(this.value);adjustQtySelectOptions(this.value);});
els.nameInput.addEventListener('input',function(){checkHerbalNewMember(this.value);adjustQtySelectOptions(this.value);});
els.addBtn.addEventListener("click",addProduct);
els.resetCalculatorBtn.addEventListener("click",resetLineName);
els.resetReportBtn.addEventListener("click",resetReport);
els.exportBtn.addEventListener("click",exportToImage);
els.shareToLineBtn.addEventListener("click",shareToLine);
els.nativeShareBtn.addEventListener("click",nativeShare);
els.clearImageBtn.addEventListener("click",clearImage);
els.reportBody.addEventListener("click",async function(e){
  const btn=e.target.closest('.deleteBtn');
  if(!btn||isDeleting||btn.disabled)return;
  await handleDelete(btn);
});
window.addEventListener('resize',()=>{els.reportTable.style.fontSize=window.innerWidth<360?'11px':'12px';});
window.onload=initApp;

// è‰æœ¬æ–°å…¥æœƒæé†’
function checkHerbalNewMember(selectedValue){
  const val=selectedValue.trim();
  if(val.includes('è‰æœ¬')&&val.includes('æ–°å…¥æœƒ')){
    setTimeout(()=>{alert('ğŸ“‹ æ–°å…¥æœƒè‰æœ¬çµ„åˆæé†’ï¼š\n\nç”·ç”Ÿæ¬¾ï¼š211x2 + 101x2\nå¥³ç”Ÿæ¬¾ï¼š211x2 + 707x2\n\nè«‹åˆ†åˆ¥æ–°å¢å°æ‡‰å“é …èˆ‡æ•¸é‡');},100);
  }
}

// èª¿æ•´æ•¸é‡é¸æ“‡æ¡†é¸é …
function adjustQtySelectOptions(selectedValue){
  const val=selectedValue.trim();
  let maxQty=99;
  if(val.includes('æ–°å…¥æœƒ')||val.includes('æ–°æœƒå“¡')||val.includes('å…¥æœƒ')||val.includes('ä¸‰å¯¶')||val.includes('å›æ˜¥'))maxQty=1;
  else if(val.includes('2711AB')&&val.includes('(4)'))maxQty=2;
  else if(val.includes('777Q')&&val.includes('(4)'))maxQty=2;
  els.qtyInput.innerHTML='';
  for(let i=1;i<=maxQty;i++){
    const option=document.createElement("option");
    option.value=i;
    option.textContent=i;
    els.qtyInput.appendChild(option);
  }
}

// åŠ è¼‰å·²é¸å•†å“
function loadSelectedProds(){
  const saved=localStorage.getItem('selectedProducts');
  if(saved)selectedProds=JSON.parse(saved);
  renderTable();
}

// ä¿å­˜å·²é¸å•†å“
function saveSelectedProds(){localStorage.setItem('selectedProducts',JSON.stringify(selectedProds));}
function saveUserUsageRecord(){localStorage.setItem('userUsageRecord',JSON.stringify(userUsageRecord));}

// è¨­ç½®LINEåç¨±
function setupLineName(isReset=false){
  if(isReset){
    const input=prompt('è«‹è¼¸å…¥æ‚¨çš„ã€è©¦ç®—è€…åç¨±ã€\nï¼ˆå¯éš¨æ™‚é»æ“Šé‡ç½®æŒ‰éˆ•ä¿®æ”¹ï¼‰ï¼š');
    lineName=input?.trim()||'æœªè¨­å®š';
    localStorage.setItem('lineName',lineName);
  }else{
    lineName=localStorage.getItem('lineName')||userInfo?.displayName||'';
    if(!lineName||lineName==='æœªçŸ¥ç”¨æˆ¶å'){
      const input=prompt('è«‹è¼¸å…¥æ‚¨çš„ã€è©¦ç®—è€…åç¨±ã€\nï¼ˆå¯éš¨æ™‚é»æ“Šé‡ç½®æŒ‰éˆ•ä¿®æ”¹ï¼‰ï¼š');
      lineName=input?.trim()||'æœªè¨­å®š';
      localStorage.setItem('lineName',lineName);
    }
  }
  els.calculatorDisplay.value=lineName;
}

// é‡ç½®LINEåç¨±
function resetLineName(){
  if(confirm('ç¢ºå®šè¦ä¿®æ”¹è©¦ç®—è€…åç¨±å—ï¼Ÿ')){
    localStorage.removeItem('lineName');
    setupLineName(true);
    showToast('è©¦ç®—è€…åç¨±å·²æ›´æ–°');
  }
}

// åŒæ­¥é‡ç½®è¨˜éŒ„åˆ°å¾Œç«¯
async function syncRecordResetToBackend(){
  if(!userInfo||authStatus.isVip||authStatus.isSuperAdmin)return true;
  return new Promise((resolve,reject)=>{
    const callbackName=`recordResetCallback_${Date.now()}`;
    window[callbackName]=function(resp){
      delete window[callbackName];
      if(resp.status==="success"){
        const backendUsageCount=resp.usageCount||0;
        userUsageRecord[userInfo.userId]=backendUsageCount;
        saveUserUsageRecord();
        authStatus.remainingTimes=MAX_NORMAL_USER_USAGE-backendUsageCount;
        updateAuthStatusBar();
        checkUserRemainingTimes();
        resolve(true);
      }else{
        showToast(`å¾Œç«¯æ‰£æ¬¡å¤±æ•—ï¼š${resp.message||'æœªçŸ¥éŒ¯èª¤'}`, 'error');
        resolve(false);
      }
    };
    const data={
      action:'recordReset',
      userId:userInfo.userId,
      displayName:userInfo.displayName,
      callback:callbackName,
      dataType:'resetRecord'
    };
    $.ajax({
      url:API_URL,
      dataType:'jsonp',
      jsonp:'callback',
      jsonpCallback:callbackName,
      timeout:JSONP_TIMEOUT,
      data:data,
      error:function(xhr,status,error){
        delete window[callbackName];
        const errorMsg=status==='timeout'?'æ‰£æ¬¡åŒæ­¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡':`æ‰£æ¬¡åŒæ­¥å¤±æ•—ï¼š${error}`;
        showToast(errorMsg, 'error');
        reject(new Error(errorMsg));
      }
    });
  });
}

// åŒæ­¥åˆªé™¤è¨˜éŒ„åˆ°å¾Œç«¯
async function syncDeleteToBackend(){
  if(!userInfo||authStatus.isVip||authStatus.isSuperAdmin)return true;
  return new Promise((resolve,reject)=>{
    const callbackName=`recordDeleteCallback_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
    window[callbackName]=function(resp){
      delete window[callbackName];
      if(resp&&resp.status==="success"){
        const backendUsageCount=Number(resp.usageCount)||0;
        userUsageRecord[userInfo.userId]=backendUsageCount;
        saveUserUsageRecord();
        authStatus.remainingTimes=MAX_NORMAL_USER_USAGE-backendUsageCount;
        updateAuthStatusBar();
        checkUserRemainingTimes();
        resolve(true);
      }else{
        showToast(`å¾Œç«¯æœªæ‰£æ¬¡ï¼š${resp?.message||'3åˆ†é˜å…§é‡è¤‡æ“ä½œï¼Œç„¡éœ€æ‰£æ¬¡'}`, 'warning');
        resolve(false);
      }
    };
    const data={
      action:'recordDelete',
      userId:userInfo.userId,
      displayName:userInfo.displayName,
      usageCount:userUsageRecord[userInfo.userId]||0,
      timestamp:new Date().getTime(),
      callback:callbackName,
      dataType:'deleteRecord'
    };
    $.ajax({
      url:API_URL,
      dataType:'jsonp',
      jsonp:'callback',
      jsonpCallback:callbackName,
      timeout:JSONP_TIMEOUT,
      cache:false,
      data:data,
      error:function(xhr,status,error){
        delete window[callbackName];
        const errorMsg=status==='timeout'?'åˆªé™¤æ‰£æ¬¡åŒæ­¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡è©¦':`åˆªé™¤æ‰£æ¬¡åŒæ­¥å¤±æ•—ï¼š${error||'ç¶²çµ¡éŒ¯èª¤'}`;
        showToast(errorMsg, 'error');
        reject(new Error(errorMsg));
      }
    });
  });
}

// é‡ç½®å ±è¡¨
async function resetReport(){
  if(!authStatus||authStatus.isExpired)return;
  if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å“é …è¨˜éŒ„å—ï¼Ÿ'))return;
  const isPrivilegeUser=authStatus.isVip||authStatus.isSuperAdmin;
  let isDeducted=false;
  if(!isPrivilegeUser&&authStatus.remainingTimes>0){
    els.resetReportBtn.disabled=true;
    els.resetReportBtn.textContent="è™•ç†ä¸­...";
    try{
      const syncSuccess=await syncRecordResetToBackend();
      isDeducted=syncSuccess;
    }catch(error){
      showToast(error.message, 'error');
    }finally{
      els.resetReportBtn.disabled=false;
      els.resetReportBtn.textContent="ğŸ”„ é‡ç½®å ±è¡¨";
    }
  }
  selectedProds=[];
  saveSelectedProds();
  renderTable();
  adjustQtySelectOptions(els.nameInput.value);
  isDeducted?showToast(`âœ… å·²æ‰£é™¤1æ¬¡ä½¿ç”¨æ¬¡æ•¸ï¼Œå‰©é¤˜${authStatus.remainingTimes}/${MAX_NORMAL_USER_USAGE}æ¬¡`, 'warning'):showToast('å ±è¡¨å·²é‡ç½®');
}

// åŠ è¼‰å•†å“åˆ—è¡¨
async function loadProducts(){
  try{
    const res=await fetch(`${API_URL}?action=all&t=${new Date().getTime()}`,{cache:'no-cache'});
    const data=await res.json();
    products=data;
    els.nameInput.innerHTML="";
    data.forEach(item=>{
      const opt=document.createElement("option");
      opt.value=item.name;
      opt.textContent=item.name;
      els.nameInput.appendChild(opt);
    });
    setTimeout(()=>{checkHerbalNewMember(els.nameInput.value);adjustQtySelectOptions(els.nameInput.value);},300);
  }catch(error){
    showToast(`è®€å–å•†å“å¤±æ•—: ${error.message||'æœªçŸ¥éŒ¯èª¤'}`, 'error');
  }
}

// æ¸²æŸ“è¡¨æ ¼
function renderTable(){
  els.reportBody.innerHTML="";
  let totalPrice=0,totalPv=0;
  selectedProds.forEach((item,idx)=>{
    const val=item.name.trim();
    let maxQty=99;
    if(val.includes('æ–°å…¥æœƒ')||val.includes('æ–°æœƒå“¡')||val.includes('å…¥æœƒ'))maxQty=1;
    else if(val.includes('2711AB')&&val.includes('(4)'))maxQty=2;
    else if(val.includes('777Q')&&val.includes('(4)'))maxQty=2;
    if(item.qty>maxQty){item.qty=maxQty;saveSelectedProds();}
    const subtotalPrice=item.price*item.qty;
    const subtotalPv=item.pv*item.qty;
    totalPrice+=subtotalPrice;
    totalPv+=subtotalPv;
    const tr=document.createElement("tr");
    const qtyOptions=Array.from({length:maxQty},(_,i)=>{
      const val=i+1;
      return `<option value="${val}" ${val===item.qty?"selected":""}>${val}</option>`;
    }).join("");
    tr.innerHTML=`
      <td style="text-align:center;">${item.name}</td>
      <td>
        <select class="qtySelect" data-index="${idx}" style="text-align:center;">
          ${qtyOptions}
        </select>
      </td>
      <td style="text-align:center;">${item.price}</td>
      <td style="text-align:center;">${item.pv}</td>
      <td style="text-align:center;">${subtotalPrice}</td>
      <td style="text-align:center;">${subtotalPv}</td>
      <td><button class="deleteBtn" data-index="${idx}">åˆªé™¤</button></td>
    `;
    els.reportBody.appendChild(tr);
  });
  els.totalPriceCellDup.textContent=totalPrice;
  els.totalPvCellDup.textContent=totalPv;
  const diff1=TARGET_PV112-totalPv;
  const diff2=TARGET_PV220-totalPv;
  els.pvDiff.textContent=diff1>0?diff1:0;
  els.pvDiff2.textContent=diff2>0?diff2:0;
  els.pvMessage1.innerHTML=totalPv>=TARGET_PV112?'<span class="done">ğŸ‰ å·²é”æ¨™</span>':'';
  els.pvMessage2.innerHTML=totalPv>=TARGET_PV220?'<span class="done">ğŸ‰ å·²é”æ¨™</span>':'';
  document.querySelectorAll(".qtySelect").forEach(select=>{
    select.onchange=e=>{
      const idx=parseInt(e.target.dataset.index);
      selectedProds[idx].qty=parseInt(e.target.value);
      saveSelectedProds();
      renderTable();
    };
  });
}

// è™•ç†åˆªé™¤æ“ä½œ
async function handleDelete(btn){
  if(isDeleting||!authStatus||authStatus.isExpired){
    showToast('è³¬è™Ÿå·²éæœŸæˆ–æ“ä½œä¸­ï¼Œç„¡æ³•åŸ·è¡Œåˆªé™¤', 'error');
    return;
  }
  const idx=parseInt(btn.dataset.index);
  const isPrivilegeUser=authStatus.isVip||authStatus.isSuperAdmin;
  if(!isPrivilegeUser){
    if(authStatus.remainingTimes<=0){
      showToast('ä½¿ç”¨æ¬¡æ•¸å·²ç”¨å®Œï¼Œç„¡æ³•åˆªé™¤å“é …', 'error');
      return;
    }
    const now=Date.now();
    const isWithinInterval=now-lastDeductTime<DEDUCT_INTERVAL;
    const confirmMsg=isWithinInterval
      ? `åˆªé™¤æ­¤å“é …ï¼ˆ3åˆ†é˜å…§é€£çºŒæ“ä½œï¼Œä¸æ‰£é™¤ä½¿ç”¨æ¬¡æ•¸ï¼‰ï¼Œç•¶å‰å‰©é¤˜${authStatus.remainingTimes}/${MAX_NORMAL_USER_USAGE}æ¬¡ï¼Œæ˜¯å¦ç¢ºèªåˆªé™¤ï¼Ÿ`
      : `åˆªé™¤æ­¤å“é …å°‡æ‰£é™¤1æ¬¡ä½¿ç”¨æ¬¡æ•¸ï¼Œ3åˆ†é˜å…§é€£çºŒåˆªé™¤ä¸æ‰£æ¬¡ï¼Œç•¶å‰å‰©é¤˜${authStatus.remainingTimes}/${MAX_NORMAL_USER_USAGE}æ¬¡ï¼Œæ˜¯å¦ç¢ºèªåˆªé™¤ï¼Ÿ`;
    if(!isWithinInterval&&!confirm(confirmMsg)){
      return;
    }
  }
  isDeleting=true;
  btn.disabled=true;
  btn.textContent="è™•ç†ä¸­";
  try{
    const now=Date.now();
    const isWithinInterval=now-lastDeductTime<DEDUCT_INTERVAL;
    selectedProds.splice(idx,1);
    saveSelectedProds();
    renderTable();
    if(!isPrivilegeUser&&!isWithinInterval){
      const syncSuccess=await syncDeleteToBackend();
      if(syncSuccess){
        lastDeductTime=now;
        localStorage.setItem('lastDeductTime',lastDeductTime.toString());
        showToast(`âœ… å·²æ‰£é™¤1æ¬¡ä½¿ç”¨æ¬¡æ•¸ï¼Œå‰©é¤˜${authStatus.remainingTimes}/${MAX_NORMAL_USER_USAGE}æ¬¡ï¼ˆ3åˆ†é˜å…§é€£çºŒåˆªé™¤ä¸æ‰£æ¬¡ï¼‰`, 'warning');
      }else{
        showToast('å“é …å·²åˆªé™¤ï¼Œå¾Œç«¯æœªæ‰£æ¬¡ï¼ˆ3åˆ†é˜å…§é‡è¤‡æ“ä½œ/åŒæ­¥å¤±æ•—ï¼‰', 'warning');
      }
    }else if(!isPrivilegeUser&&isWithinInterval){
      showToast(`å“é …å·²åˆªé™¤ï¼ˆ3åˆ†é˜å…§é€£çºŒåˆªé™¤ï¼Œä¸æ‰£é™¤ä½¿ç”¨æ¬¡æ•¸ï¼‰ï¼Œå‰©é¤˜${authStatus.remainingTimes}/${MAX_NORMAL_USER_USAGE}æ¬¡`, 'success');
    }else{
      showToast('å“é …å·²åˆªé™¤', 'success');
    }
  }catch(error){
    showToast(`åˆªé™¤å¤±æ•—ï¼š${error.message}`, 'error');
    renderTable();
  }finally{
    isDeleting=false;
    btn.disabled=false;
    btn.textContent="åˆªé™¤";
  }
}

// æ–°å¢å•†å“
function addProduct(){
  els.addBtn.disabled=true;
  els.addBtn.textContent="è™•ç†ä¸­...";
  try{
    if(!authStatus){
      showToast('è«‹å…ˆå®Œæˆç”¨æˆ¶æ¬Šé™é©—è­‰', 'error');
      return;
    }
    const isPrivilegeUser=authStatus.isVip||authStatus.isSuperAdmin;
    if(!isPrivilegeUser&&authStatus.remainingTimes<=0){
      showToast(`æ™®é€šç”¨æˆ¶ä½¿ç”¨æ¬¡æ•¸å·²é”ä¸Šé™ï¼ˆ${MAX_NORMAL_USER_USAGE}æ¬¡ï¼‰ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡å‡ç´š`, 'error');
      return;
    }
    const selectedName=els.nameInput.value;
    let qty=parseInt(els.qtyInput.value);
    if(!selectedName||qty<=0){
      alert("è«‹é¸æ“‡å“é …èˆ‡æ•¸é‡");
      return;
    }
    const val=selectedName.trim();
    let maxQty=99;
    if(val.includes('æ–°å…¥æœƒ')||val.includes('æ–°æœƒå“¡')||val.includes('å…¥æœƒ')){
      maxQty=1;
      if(qty>maxQty){
        alert(`âš ï¸ æ–°å…¥æœƒç›¸é—œå“é …é™è³¼${maxQty}å€‹ï¼Œå·²è‡ªå‹•èª¿æ•´æ•¸é‡ç‚º${maxQty}`);
        qty=maxQty;
      }
    }else if(val.includes('2711AB')&&val.includes('(4)')){
      maxQty=2;
      if(qty>maxQty){
        alert(`âš ï¸ 2711AB(4)é™è³¼${maxQty}çµ„ï¼Œå·²è‡ªå‹•èª¿æ•´æ•¸é‡ç‚º${maxQty}`);
        qty=maxQty;
      }
    }else if(val.includes('777Q')&&val.includes('(4)')){
      maxQty=2;
      if(qty>maxQty){
        alert(`âš ï¸ 777Q(4)é™è³¼${maxQty}çµ„ï¼Œå·²è‡ªå‹•èª¿æ•´æ•¸é‡ç‚º${maxQty}`);
        qty=maxQty;
      }
    }
    const product=products.find(p=>p.name===selectedName);
    if(!product){
      alert("æ‰¾ä¸åˆ°è©²å“é …");
      return;
    }
    const exists=selectedProds.find(p=>p.name===selectedName);
    if(exists){
      const totalQty=exists.qty+qty;
      if(totalQty>maxQty){
        alert(`âš ï¸ è©²å“é …é™è³¼${maxQty}å€‹/çµ„ï¼Œç›®å‰å·²é¸${exists.qty}å€‹/çµ„ï¼Œç„¡æ³•å†æ–°å¢`);
        return;
      }
      exists.qty+=qty;
    }else{
      selectedProds.push({...product,qty});
    }
    saveSelectedProds();
    renderTable();
    showToast('å“é …å·²æ–°å¢');
  }catch(error){
    showToast(`æ–°å¢å¤±æ•—ï¼š${error.message}`, 'error');
  }finally{
    els.addBtn.disabled=false;
    els.addBtn.textContent="â• æ–°å¢å“é …";
  }
}

// æª¢æŸ¥ç”¨æˆ¶å‰©é¤˜æ¬¡æ•¸
function checkUserRemainingTimes(){
  if(!authStatus)return false;
  const isPrivilegeUser=authStatus.isVip||authStatus.isSuperAdmin;
  if(authStatus.isExpired){
    els.exportBtn.disabled=true;els.addBtn.disabled=true;els.shareToLineBtn.disabled=true;els.resetReportBtn.disabled=true;
    return false;
  }
  if(isPrivilegeUser){
    els.exportBtn.disabled=false;els.addBtn.disabled=false;els.shareToLineBtn.disabled=false;els.resetReportBtn.disabled=false;
    return true;
  }
  const userId=userInfo.userId;
  const usedTimes=userUsageRecord[userId]||0;
  authStatus.remainingTimes=MAX_NORMAL_USER_USAGE-usedTimes;
  updateAuthStatusBar();
  if(authStatus.remainingTimes<=0){
    els.exportBtn.disabled=true;els.addBtn.disabled=true;els.shareToLineBtn.disabled=true;els.resetReportBtn.disabled=true;
    return false;
  }else{
    els.exportBtn.disabled=false;els.addBtn.disabled=false;els.shareToLineBtn.disabled=true;els.resetReportBtn.disabled=false;
    return true;
  }
}

// è¨˜éŒ„ç”¨æˆ¶ä½¿ç”¨æ¬¡æ•¸
function recordUserUsage(){
  if(!authStatus)return;
  const isPrivilegeUser=authStatus.isVip||authStatus.isSuperAdmin;
  if(isPrivilegeUser)return;
  const userId=userInfo.userId;
  const beforeRemaining=authStatus.remainingTimes;
  if(beforeRemaining<=0)return;
  userUsageRecord[userId]=(userUsageRecord[userId]||0)+1;
  saveUserUsageRecord();
  authStatus.remainingTimes=MAX_NORMAL_USER_USAGE-userUsageRecord[userId];
  updateAuthStatusBar();
}

// æ›´æ–°æˆæ¬Šç‹€æ…‹æ¬„
function updateAuthStatusBar(){
  if(!authStatus||!userInfo)return;
  let statusHtml='';
  if(authStatus.isSuperAdmin){
    const expiryText=authStatus.remainingDays==="æ°¸ä¹…æœ‰æ•ˆ"?"æ°¸ä¹…æœ‰æ•ˆ":`${authStatus.displayExpiryDate} | å‰©é¤˜ï¼š<span class="remaining-days-yellow">${authStatus.remainingDays}</span>`;
    statusHtml=`
      <span class="super-admin">ğŸ‘‘ è¶…ç´šç®¡ç†å“¡ ğŸ‘‘</span> | 
      ç”¨æˆ¶åï¼š<span class="super-admin-username">${userInfo.displayName}</span>
      <br/>æœ‰æ•ˆæœŸé™ï¼š${expiryText}
    `;
  }else if(authStatus.isVip){
    const expiryText=authStatus.remainingDays==="æ°¸ä¹…æœ‰æ•ˆ"?"æ°¸ä¹…æœ‰æ•ˆ":`${authStatus.displayExpiryDate} | å‰©é¤˜ï¼š<span class="remaining-days-yellow">${authStatus.remainingDays}</span>`;
    statusHtml=`
      <span class="vip-admin">ğŸ’ å°Šçˆµç”¨æˆ¶ ğŸ’</span> | 
      ç”¨æˆ¶åï¼š<span class="vip-admin-username">${userInfo.displayName}</span>
      <br/>æœ‰æ•ˆæœŸé™ï¼š${expiryText}
    `;
  }else{
    statusHtml=`
      <span class="normal">ğŸª™ æ™®é€šç”¨æˆ¶ ğŸª™</span> | 
      ç”¨æˆ¶åï¼š${userInfo.displayName}
      <br/>å‰©é¤˜ä½¿ç”¨æ¬¡æ•¸ï¼š<span class="${authStatus.remainingTimes<=0?'expired':'normal'}">${authStatus.remainingTimes||0}/${MAX_NORMAL_USER_USAGE}æ¬¡</span>
    `;
  }
  // ä¿®æ”¹ï¼šå°†çŠ¶æ€å†…å®¹æ’å…¥åˆ°å…³é—­æŒ‰é’®ä¹‹å
  els.authStatusBar.innerHTML = `
    <button class="close-status" title="éš±è—ç‹€æ…‹æ¬„">âœ•</button>
    ${statusHtml}
  `;
  // é‡æ–°ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
  els.authStatusBar.querySelector('.close-status').addEventListener('click',function(){
    els.authStatusBar.style.opacity='0';
    setTimeout(()=>{
      els.authStatusBar.style.display='none';
      els.authStatusBar.style.opacity='1';
    },300);
  });
  els.authStatusBar.style.display='block';
}

// åŒ¯å‡ºåœ–ç‰‡
async function exportToImage(){
  if(!checkUserRemainingTimes())return;
  if(selectedProds.length===0){alert("è«‹å…ˆæ–°å¢è‡³å°‘ä¸€å€‹å“é …ï¼Œæ‰èƒ½åŒ¯å‡ºåœ–ç‰‡ï¼");return;}
  els.exportBtn.disabled=true;
  els.exportBtn.textContent="åŒ¯å‡ºä¸­...";
  const opCells=document.querySelectorAll("#reportTable td:last-child, #reportTable th:last-child");
  opCells.forEach(el=>{el.style.display="none";});
  els.reportTable.offsetWidth;
  const tableWidth=els.reportTable.offsetWidth;
  const lastCol=els.reportTable.querySelector('th:last-child');
  const lastColWidth=lastCol?lastCol.offsetWidth:0;
  const captureWidth=(tableWidth-lastColWidth)+60;
  const originalCaptureWidth=els.captureArea.style.width;
  const originalPaddingRight=els.captureArea.style.paddingRight;
  const originalPaddingLeft=els.captureArea.style.paddingLeft;
  els.captureArea.style.width=`${captureWidth}px`;
  els.captureArea.style.paddingLeft="30px";
  els.captureArea.style.paddingRight="30px";
  try{
    const scale=window.innerWidth<768?3:4;
    const canvas=await html2canvas(els.captureArea,{
      scale:scale,useCORS:true,allowTaint:true,backgroundColor:null,
      logging:false,letterRendering:true,useTransform:true,dpi:300,
      scaleMethod:'highQuality',width:captureWidth,windowWidth:captureWidth,
      windowHeight:els.captureArea.offsetHeight,scrollX:0,scrollY:0,
      ignoreElements:el=>el.id==='previewImage'||el.classList.contains('deleteBtn')
    });
    const dataUrl=canvas.toDataURL("image/png",1.0);
    els.previewImage.src=dataUrl;
    els.previewImage.style.display="block";
    els.shareToLineBtn.style.display="inline-block";
    els.nativeShareBtn.style.display=navigator.share?"inline-block":"none";
    els.clearImageBtn.style.display="inline-block";
  }catch(error){
    showToast(`åŒ¯å‡ºå¤±æ•—ï¼š${error.message||'æœªçŸ¥éŒ¯èª¤'}`, 'error');
  }finally{
    opCells.forEach(el=>{el.style.display="";});
    els.captureArea.style.width=originalCaptureWidth;
    els.captureArea.style.paddingRight=originalPaddingRight;
    els.captureArea.style.paddingLeft=originalPaddingLeft;
    els.exportBtn.disabled=false;
    els.exportBtn.textContent="ğŸ“¤ å ±è¡¨è½‰åœ–ç‰‡";
  }
}

// åˆ†äº«åˆ°LINE
async function shareToLine(){
  if(!authStatus)return;
  if(!els.previewImage.src){alert("è«‹å…ˆåŒ¯å‡ºåœ–ç‰‡");return;}
  els.shareToLineBtn.disabled=true;
  els.shareToLineBtn.textContent="ä¸Šå‚³ä¸­...";
  try{
    const base64Data=els.previewImage.src.split(",")[1];
    const formData=new FormData();
    formData.append("image",base64Data);
    formData.append("key",IMGBB_API_KEY);
    const res=await fetch("https://api.imgbb.com/1/upload",{method:"POST",body:formData,});
    const result=await res.json();
    if(result.success){
      const imageUrl=result.data.url;
      const buyerName=els.buyerInput.value.trim()||"æœªå¡«";
      const calculatorName=lineName||"æœªè¨­å®š";
      const lineShareUrl=`https://line.me/R/msg/text/?${encodeURIComponent(`åº·åœ’è©¦ç®—å ±è¡¨\n\nè³¼è²·è€…ï¼š${buyerName}\nè©¦ç®—è€…ï¼š${calculatorName}\n${imageUrl}`)}`;
      window.open(lineShareUrl,"_blank");
      showToast("âœ… åœ–ç‰‡å·²ä¸Šå‚³");
    }else{
      showToast("åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", 'error');
    }
  }catch(error){
    showToast(`åœ–ç‰‡ä¸Šå‚³éŒ¯èª¤: ${error.message||'æœªçŸ¥éŒ¯èª¤'}`, 'error');
  }finally{
    els.shareToLineBtn.disabled=false;
    els.shareToLineBtn.textContent="ğŸ“© åœ–ç‰‡ä¸Šå‚³";
  }
}

// åŸç”Ÿåˆ†äº«
async function nativeShare(){
  if(!authStatus)return;
  if(!navigator.share||!els.previewImage.src){alert("ç„¡æ³•ä½¿ç”¨åŸç”Ÿåˆ†äº«");return;}
  try{
    const response=await fetch(els.previewImage.src);
    const blob=await response.blob();
    const filesArray=[new File([blob],"åº·åœ’è©¦ç®—å ±è¡¨.png",{type:blob.type})];
    const buyer=els.buyerInput.value.trim()||"æœªå¡«";
    const calculator=lineName||"æœªè¨­å®š";
    const shareText=`åº·åœ’è©¦ç®—å ±è¡¨\nè³¼è²·è€…ï¼š${buyer}\nè©¦ç®—è€…ï¼š${calculator}`;
    await navigator.share({files:filesArray,title:"åº·åœ’è©¦ç®—å ±è¡¨",text:shareText,});
  }catch(error){
    showToast(`åˆ†äº«å¤±æ•—: ${error.message||'æœªçŸ¥éŒ¯èª¤'}`, 'error');
  }
}

// æ¸…é™¤åœ–ç‰‡
function clearImage(){
  els.previewImage.style.display="none";
  els.previewImage.src="";
  els.shareToLineBtn.style.display="none";
  els.nativeShareBtn.style.display="none";
  els.clearImageBtn.style.display="none";
}

// é¡¯ç¤ºæç¤ºæ¡†
function showToast(message,type='success'){
  // å…³é”®ä¿®æ”¹ï¼šæ›¿æ¢ \n ä¸º <br>ï¼Œå¹¶ç”¨ innerHTML èµ‹å€¼
  els.toast.innerHTML=message.replace(/\n/g, '<br>');
  els.toast.className='toast';
  els.toast.classList.add(type);
  els.toast.classList.add("show");
  setTimeout(()=>els.toast.classList.remove("show"),3000);
}

// è¨ˆç®—å‰©é¤˜å¤©æ•¸
const calculateRemainingDaysByDate=(expiryDateStr)=>{
  try{
    if(expiryDateStr===PERMANENT_EXPIRY_DATE)return{displayDate:"æ°¸ä¹…æœ‰æ•ˆ",remainingDays:"æ°¸ä¹…æœ‰æ•ˆ",isExpired:false};
    const dateReg=/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/;
    if(!dateReg.test(expiryDateStr))return{displayDate:"æ ¼å¼éŒ¯èª¤",remainingDays:"æ ¼å¼éŒ¯èª¤",isExpired:true};
    const dateParts=expiryDateStr.replace(/-/g,'/').split('/').map(Number);
    const [year,month,day]=dateParts;
    const expiryDate=new Date(year,month-1,day,23,59,59,999);
    const now=new Date();
    if(isNaN(expiryDate.getTime()))return{displayDate:"æ—¥æœŸç„¡æ•ˆ",remainingDays:"æ—¥æœŸç„¡æ•ˆ",isExpired:true};
    const oneDayMs=1000*3600*24;
    const timeDiff=expiryDate.getTime()-now.getTime();
    let dayDiff=Math.ceil(timeDiff/oneDayMs);
    const fmtMonth=String(month).padStart(2,'0');
    const fmtDay=String(day).padStart(2,'0');
    const displayDate=`${year}/${fmtMonth}/${fmtDay}`;
    let remainingDaysText,isExpired=false;
    if(timeDiff<0){remainingDaysText="<span class='expired'>å·²éæœŸ</span>";isExpired=true;}
    else if(dayDiff===0){remainingDaysText="<span class='warning'>æœ€å¾Œ1å¤©</span>";isExpired=false;}
    else if(dayDiff<=30){remainingDaysText=`<span class='warning'>${dayDiff} å¤©</span>`;isExpired=false;}
    else{remainingDaysText=`${dayDiff} å¤©`;isExpired=false;}
    return{displayDate,remainingDays:remainingDaysText,isExpired};
  }catch(e){
    return{displayDate:"è¨ˆç®—éŒ¯èª¤",remainingDays:"è¨ˆç®—éŒ¯èª¤",isExpired:true};
  }
};

// é¡¯ç¤ºéŒ¯èª¤
const showError=(msg)=>{
  els.authLoading.style.display='none';
  els.captureArea.style.display='none';
  els.inputArea.style.display='none';
  els.buttonGroup.style.display='none';
  els.errorContent.innerHTML=`<p class="font-medium">${msg}</p>`;
  els.errorMessage.style.display='block';
};

// å¾Œç«¯é©—è­‰ç”¨æˆ¶
const verifyUserFromBackend=(profile)=>{
  return new Promise((resolve,reject)=>{
    const callbackName=`verifyCallback_${Date.now()}`;
    window[callbackName]=function(resp){
      delete window[callbackName];
      if(resp.status==="success"){
        const backendUsageCount=resp.usageCount||0;
        userUsageRecord[profile.userId]=backendUsageCount;
        saveUserUsageRecord();
        const expiryData=calculateRemainingDaysByDate(resp.expiryDate||PERMANENT_EXPIRY_DATE);
        const authData={
          ...resp,displayName:profile.displayName,remainingDays:expiryData.remainingDays,
          displayExpiryDate:expiryData.displayDate,isExpired:expiryData.isExpired,
          isVip:resp.isVip===true,isSuperAdmin:resp.isSuperAdmin===true,
          remainingTimes:resp.remainingTimes||(MAX_NORMAL_USER_USAGE-backendUsageCount)
        };
        // ä¿å­˜VIP/è¶…ç®¡çš„ç•¶å¤©é©—è­‰ç·©å­˜
        if(authData.isVip||authData.isSuperAdmin){
          saveTodayAuthCache(profile.userId,authData);
        }
        resolve(authData);
      }else{
        showError(resp.message||"ç”¨æˆ¶é©—è­‰å¤±æ•—");
        resolve(null);
      }
    };
    const decodedToken=liff.getDecodedIDToken();
    const userId=profile.userId||decodedToken?.sub||"";
    const data={
      action:'verifyUser',userId:userId,displayName:profile.displayName,
      callback:callbackName,dataType:'userVerify'
    };
    $.ajax({
      url:API_URL,dataType:'jsonp',jsonp:'callback',jsonpCallback:callbackName,
      timeout:JSONP_TIMEOUT,data:data,
      error:function(xhr,status,error){
        delete window[callbackName];
        const errorMsg=status==='timeout'?'é©—è­‰è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡å¾Œé‡æ–°å˜—è©¦':`é©—è­‰å¤±æ•—ï¼š${error||'æœªçŸ¥ç¶²çµ¡éŒ¯èª¤'}`;
        showError(errorMsg);
        reject(new Error(errorMsg));
      }
    });
  });
};

// åˆå§‹åŒ–LIFFå’Œæˆæ¬Š
async function initLiffAndAuth(){
  try{
    updateAuthLoadingText("æ­£åœ¨é©—è­‰","è«‹ç¨å€™...");
    await liff.init({liffId:LIFF_ID,withLoginOnExternalBrowser:true,scope:'profile openid email'});
    loadProducts();
    if(!liff.isLoggedIn()){
      updateAuthLoadingText("è«‹å…ˆç™»éŒ„LINEè³¬è™Ÿ","å°‡è‡ªå‹•è·³è½‰è‡³ç™»éŒ„é é¢...");
      liff.login({redirectUri:window.location.href});
      return;
    }
    const profile=await liff.getProfile();
    userInfo={userId:profile.userId,displayName:profile.displayName};
    
    // æª¢æŸ¥æ˜¯å¦æ˜¯VIP/è¶…ç®¡ä¸”æœ‰ç•¶å¤©æœ‰æ•ˆé©—è­‰ç·©å­˜
    const isPrivilegeUserCached=isTodayValidAuth(profile.userId);
    if(isPrivilegeUserCached){
      // ä½¿ç”¨ç·©å­˜çš„é©—è­‰æ•¸æ“š
      authStatus=JSON.parse(localStorage.getItem(`authCache_${profile.userId}`)).data;
      els.authLoading.style.display='none';
      document.getElementById('authContainer').style.display='none';
      els.captureArea.style.display='block';
      els.inputArea.style.display='flex';
      els.buttonGroup.style.display='flex';
      setupLineName();
      loadSelectedProds();
      checkUserRemainingTimes();
      updateAuthStatusBar();
      showToast(`æ­¡è¿ğŸ’å°Šçˆµç”¨æˆ¶ğŸ’<br>${userInfo.displayName}<br>é©—è­‰ä¸€æ¬¡<br>ä¿ç•™24å°æ™‚<br>`);
      return;
    }
    
    // æ™®é€šç”¨æˆ¶æˆ–ç·©å­˜éæœŸï¼Œèµ°æ­£å¸¸é©—è­‰æµç¨‹
    updateAuthLoadingText("å½¥å½¬ğŸŒ¿è©¦ç®—ç³»çµ±","æ ¸å°ç”¨æˆ¶æ¬Šé™ä¸­...");
    const authData=await verifyUserFromBackend(profile);
    if(!authData)return;
    if(authData.isExpired){
      showError('æ‚¨çš„è³¬è™Ÿå·²éæœŸï¼Œç„¡æ³•ç™»éŒ„è©¦ç®—ç³»çµ±ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡çºŒæœŸ');
      return;
    }
    authStatus=authData;
    els.authLoading.style.display='none';
    document.getElementById('authContainer').style.display='none';
    els.captureArea.style.display='block';
    els.inputArea.style.display='flex';
    els.buttonGroup.style.display='flex';
    setupLineName();
    loadSelectedProds();
    checkUserRemainingTimes();
    updateAuthStatusBar();
    showToast(`æ­¡è¿å›ä¾†ï¼Œ${userInfo.displayName}ï¼`);
  }catch(error){
    let errorMsg=error.message||'æœªçŸ¥åˆå§‹åŒ–éŒ¯èª¤';
    if(errorMsg.includes('access token expired')||errorMsg.includes('Access Token expired')){
      errorMsg='ç™»éŒ„ç‹€æ…‹å·²éæœŸï¼Œå°‡è‡ªå‹•é‡æ–°ç™»éŒ„';
      showToast(errorMsg, 'warning');
      setTimeout(()=>{
        liff.isLoggedIn()?liff.logout().then(()=>{liff.login({redirectUri:window.location.href});}):liff.login({redirectUri:window.location.href});
      },1500);

    }
    updateAuthLoadingText("åˆå§‹åŒ–å¤±æ•—",errorMsg+"<br/>è«‹åˆ·æ–°é é¢é‡æ–°å˜—è©¦");
  }
}

// æ›´æ–°æˆæƒåŠ è½½æç¤ºæ–‡æœ¬
function updateAuthLoadingText(title, desc) {
  if (els.authLoadingTitle) els.authLoadingTitle.textContent = title;
  if (els.authLoadingDesc) els.authLoadingDesc.innerHTML = desc;
}

// åˆå§‹åŒ–åº”ç”¨
async function initApp() {
  try {
    // é€‚é…å°å±å¹•è¡¨æ ¼å­—ä½“å¤§å°
    els.reportTable.style.fontSize = window.innerWidth < 360 ? '11px' : '12px';
    // åˆå§‹åŒ–LIFFå’Œæˆæƒ
    await initLiffAndAuth();
  } catch (error) {
    showError(`æ‡‰ç”¨åˆå§‹åŒ–å¤±æ•—ï¼š${error.message||'æœªçŸ¥éŒ¯èª¤'}`);
  }
}

// é”™è¯¯æç¤ºæ¡†çš„å…³é—­æŒ‰é’®ï¼ˆè¡¥å……ç»‘å®šï¼‰
document.querySelector('#error-message button')?.addEventListener('click', function() {
  els.errorMessage.style.display = 'none';
  // å°è¯•é‡æ–°åŠ è½½é¡µé¢
  setTimeout(() => {
    window.location.reload();
  }, 1000);
});

</script>
</body>
</html>
