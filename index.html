<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>品項報表匯出（串接 Google 試算表）</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  /* 深色主題 */
  body {
    background-color: #121212;
    color: #fff;
    font-family: 'Noto Sans TC', 'Arial', sans-serif;
    margin: 0;
    padding: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    user-select: none;
  }
  #inputArea { max-width: 480px; margin: 0 auto 24px; display: flex; gap: 16px; flex-wrap: wrap; align-items: center; justify-content: center; position: relative; padding: 0 8px;}
  #nameInput, #qtyInput, #addBtn {
    font-size: 1.3rem;
    border-radius: 10px;
    border: none;
    outline-offset: 2px;
    transition: box-shadow 0.2s ease;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }
  #nameInput {
    flex: 1 1 60%;
    padding: 14px 16px;
    background-color: #222;
    color: #fff;
    cursor: text;
    -webkit-user-select: text;
    user-select: text;
  }
  #nameInput:focus {
    box-shadow: 0 0 8px 3px #42a5f5;
    background-color: #333;
  }
  #autocomplete-list {
    position: absolute;
    top: 54px;
    left: 8px;
    right: calc(40% + 20px);
    max-height: 220px;
    overflow-y: auto;
    background: #222;
    border-radius: 0 0 10px 10px;
    border: 1px solid #555;
    z-index: 1000;
    display: none;
    user-select: none;
    -webkit-overflow-scrolling: touch;
  }
  #autocomplete-list div {
    padding: 14px 18px;
    cursor: pointer;
    color: #eee;
    font-size: 1.1rem;
    touch-action: manipulation;
  }
  #autocomplete-list div:hover, #autocomplete-list div.autocomplete-active {
    background-color: #444;
  }
  #qtyInput {
    flex: 1 1 20%;
    padding: 14px 16px;
    background-color: #222;
    color: #fff;
    cursor: pointer;
  }
  #qtyInput:focus {
    box-shadow: 0 0 8px 3px #42a5f5;
    background-color: #333;
  }
  #addBtn {
    flex: 1 1 18%;
    padding: 14px 0;
    background-color: #4caf50;
    color: white;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 6px 12px rgb(76 175 80 / 0.6);
    transition: background-color 0.3s ease;
    touch-action: manipulation;
    border-radius: 10px;
  }
  #addBtn:hover, #addBtn:focus {
    background-color: #45a049;
    outline: none;
  }
  #addBtn:active {
    background-color: #3b8e3a;
  }
  #captureArea {
    background: #222;
    color: #fff;
    padding: 24px 16px;
    border-radius: 14px;
    max-width: 480px;
    margin: 0 auto 24px;
    box-shadow: 0 0 24px rgba(0,0,0,0.8);
    user-select: text;
  }
  #captureArea h2 {
    text-align: center;
    margin-bottom: 20px;
    font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 1.2px;
    user-select: none;
  }
  #reportTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 1.1rem;
    table-layout: fixed;
    word-break: break-word;
  }
  #reportTable th, #reportTable td {
    border: 1px solid #555;
    padding: 12px 8px;
    text-align: center;
  }
  #reportTable thead {
    background: linear-gradient(90deg, #1e88e5, #42a5f5);
    color: #fff;
    font-weight: 700;
    letter-spacing: 0.1em;
  }
  #reportTable tfoot td {
    font-weight: 700;
    background-color: #111;
    color: #ccc;
    font-size: 1.15rem;
  }
  .deleteBtn {
    background-color: #e53935;
    border: none;
    color: white;
    border-radius: 10px;
    padding: 8px 18px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    font-size: 1rem;
    user-select: none;
    touch-action: manipulation;
  }
  .deleteBtn:hover, .deleteBtn:focus {
    background-color: #c62828;
    outline: none;
  }
  .deleteBtn:active {
    background-color: #9b1f1f;
  }
  #exportBtn {
    margin: 0 auto;
    display: block;
    padding: 18px 32px;
    font-size: 1.3rem;
    background: #4caf50;
    color: white;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    letter-spacing: 0.04em;
    box-shadow: 0 8px 16px rgb(76 175 80 / 0.7);
    user-select: none;
    max-width: 480px;
    touch-action: manipulation;
  }
  #exportBtn:hover, #exportBtn:focus {
    background: #45a049;
    outline: none;
  }
  #exportBtn:active {
    background: #3b8e3a;
  }
  @media (max-width: 480px) {
    #inputArea {
      padding: 0 12px;
      gap: 14px;
    }
    #nameInput, #qtyInput, #addBtn {
      font-size: 1.4rem;
      padding: 16px 20px;
      border-radius: 12px;
    }
    #exportBtn {
      font-size: 1.4rem;
      padding: 20px 36px;
    }
    #autocomplete-list {
      right: calc(40% + 24px);
      max-height: 240px;
    }
  }
</style>
</head>
<body>

  <div id="inputArea" role="combobox" aria-haspopup="listbox" aria-owns="autocomplete-list" aria-expanded="false">
    <input id="nameInput" type="text" placeholder="品項名稱 (輸入或選擇)" aria-autocomplete="list" aria-controls="autocomplete-list" autocomplete="off" aria-label="品項名稱" />
    <select id="qtyInput" aria-label="數量"></select>
    <button id="addBtn" aria-label="新增品項">新增品項</button>
    <div id="autocomplete-list" role="listbox" tabindex="-1"></div>
  </div>

  <div id="captureArea" aria-live="polite" aria-atomic="true" aria-relevant="all">
    <h2>🧾 品項報表</h2>
    <table id="reportTable" aria-label="品項報表">
      <thead>
        <tr>
          <th scope="col">品項名稱</th>
          <th scope="col">數量</th>
          <th scope="col">單價</th>
          <th scope="col">PV</th>
          <th scope="col">小計(元)</th>
          <th scope="col">刪除</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4">總計</td>
          <td id="totalSum" aria-live="polite" aria-atomic="true">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <button id="exportBtn" aria-label="匯出報表為圖片">匯出報表圖片</button>

<script>
  // 你的品項列表與價格及PV對應，這裡請先定義好
  const itemsData = {
    "品項A": { price: 200, pv: 50 },
    "品項B": { price: 500, pv: 150 },
    "品項C": { price: 1000, pv: 300 },
    "品項D": { price: 2500, pv: 750 },
    "品項E": { price: 750, pv: 180 },
    // 可自行新增
  };

  // 初始化數量下拉選單（1~9）
  const qtyInput = document.getElementById('qtyInput');
  for(let i=1; i<=9; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = i;
    qtyInput.appendChild(opt);
  }

  const nameInput = document.getElementById('nameInput');
  const autocompleteList = document.getElementById('autocomplete-list');
  const addBtn = document.getElementById('addBtn');
  const tbody = document.querySelector('#reportTable tbody');
  const totalSumEl = document.getElementById('totalSum');
  const exportBtn = document.getElementById('exportBtn');

  let currentFocus = -1;

  // 產生自動完成選單
  function showAutocompleteList(val) {
    autocompleteList.innerHTML = '';
    if (!val) {
      autocompleteList.style.display = 'none';
      return;
    }
    const valUpper = val.toUpperCase();
    const matchedItems = Object.keys(itemsData).filter(item => item.toUpperCase().includes(valUpper));
    if(matchedItems.length === 0) {
      autocompleteList.style.display = 'none';
      return;
    }
    matchedItems.forEach(item => {
      const div = document.createElement('div');
      div.textContent = item;
      div.tabIndex = 0;
      div.setAttribute('role', 'option');
      div.addEventListener('click', () => {
        nameInput.value = item;
        autocompleteList.style.display = 'none';
        nameInput.focus();
      });
      div.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          div.click();
        }
      });
      autocompleteList.appendChild(div);
    });
    autocompleteList.style.display = 'block';
  }

  nameInput.addEventListener('input', (e) => {
    showAutocompleteList(e.target.value);
    currentFocus = -1;
    document.getElementById('inputArea').setAttribute('aria-expanded', 'true');
  });

  nameInput.addEventListener('keydown', (e) => {
    let items = autocompleteList.getElementsByTagName('div');
    if(e.key === 'ArrowDown') {
      currentFocus++;
      if(currentFocus >= items.length) currentFocus = 0;
      addActive(items);
      e.preventDefault();
    } else if(e.key === 'ArrowUp') {
      currentFocus--;
      if(currentFocus < 0) currentFocus = items.length -1;
      addActive(items);
      e.preventDefault();
    } else if(e.key === 'Enter') {
      e.preventDefault();
      if(currentFocus > -1 && items[currentFocus]) {
        items[currentFocus].click();
      } else {
        addItem();
      }
    } else if(e.key === 'Escape') {
      autocompleteList.style.display = 'none';
      document.getElementById('inputArea').setAttribute('aria-expanded', 'false');
    }
  });

  function addActive(items) {
    if(!items) return false;
    for(let i=0; i<items.length; i++) {
      items[i].classList.remove('autocomplete-active');
    }
    if(currentFocus >= items.length) currentFocus = 0;
    if(currentFocus < 0) currentFocus = items.length -1;
    items[currentFocus].classList.add('autocomplete-active');
  }

  // 新增品項到表格
  function addItem() {
    const name = nameInput.value.trim();
    const qty = parseInt(qtyInput.value, 10);

    if(!name) {
      alert('請輸入品項名稱');
      nameInput.focus();
      return;
    }
    if(!itemsData[name]) {
      alert('品項不存在，請從自動完成選單選擇或確認品項名稱');
      nameInput.focus();
      return;
    }

    // 檢查是否已存在該品項，若存在則累加數量
    let existingRow = null;
    const rows = tbody.querySelectorAll('tr');
    for(let r of rows) {
      if(r.dataset.name === name) {
        existingRow = r;
        break;
      }
    }

    if(existingRow) {
      let qtyTd = existingRow.querySelector('.qty');
      let newQty = parseInt(qtyTd.textContent, 10) + qty;
      qtyTd.textContent = newQty;
      updateRow(existingRow, newQty);
    } else {
      const tr = document.createElement('tr');
      tr.dataset.name = name;

      const tdName = document.createElement('td');
      tdName.textContent = name;

      const tdQty = document.createElement('td');
      tdQty.textContent = qty;
      tdQty.classList.add('qty');

      const tdPrice = document.createElement('td');
      tdPrice.textContent = itemsData[name].price;

      const tdPV = document.createElement('td');
      tdPV.textContent = itemsData[name].pv;

      const tdSubtotal = document.createElement('td');
      tdSubtotal.textContent = (qty * itemsData[name].price).toLocaleString();

      const tdDel = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.className = 'deleteBtn';
      delBtn.textContent = '刪除';
      delBtn.setAttribute('aria-label', `刪除品項 ${name}`);
      delBtn.addEventListener('click', () => {
        tr.remove();
        updateTotal();
      });
      tdDel.appendChild(delBtn);

      tr.appendChild(tdName);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdPV);
      tr.appendChild(tdSubtotal);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    }

    updateTotal();
    nameInput.value = '';
    qtyInput.value = '1';
    autocompleteList.style.display = 'none';
    nameInput.focus();
  }

  // 更新表格某行的小計
  function updateRow(tr, qty) {
    const name = tr.dataset.name;
    const price = itemsData[name].price;
    const subtotalTd = tr.querySelector('td:nth-child(5)');
    subtotalTd.textContent = (qty * price).toLocaleString();
    updateTotal();
  }

  // 計算總計並顯示
  function updateTotal() {
    let total = 0;
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(tr => {
      const subtotal = parseInt(tr.querySelector('td:nth-child(5)').textContent.replace(/,/g, ''), 10);
      total += subtotal;
    });
    totalSumEl.textContent = total.toLocaleString();
  }

  addBtn.addEventListener('click', addItem);

  // Enter 鍵在品項輸入框觸發新增
  nameInput.addEventListener('keypress', e => {
    if(e.key === 'Enter') {
      e.preventDefault();
      addItem();
    }
  });

  // 匯出報表為圖片
  exportBtn.addEventListener('click', () => {
    exportBtn.disabled = true;
    exportBtn.textContent = '匯出中...';
    html2canvas(document.getElementById('captureArea'), {backgroundColor: '#121212', scale: window.devicePixelRatio})
      .then(canvas => {
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = '品項報表.png';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          exportBtn.disabled = false;
          exportBtn.textContent = '匯出報表圖片';
        }, 'image/png');
      }).catch(err => {
        alert('匯出失敗，請稍後再試。');
        exportBtn.disabled = false;
        exportBtn.textContent = '匯出報表圖片';
      });
  });

  // 點擊其他地方關閉自動完成選單
  document.addEventListener('click', (e) => {
    if(!document.getElementById('inputArea').contains(e.target)) {
      autocompleteList.style.display = 'none';
      document.getElementById('inputArea').setAttribute('aria-expanded', 'false');
    }
  });

</script>
</body>
</html>
