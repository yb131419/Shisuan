<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>品項報表匯出（串接 Google 試算表）</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  /* 深色主題 */
  body {
    background-color: #121212;
    color: #fff;
    font-family: 'Noto Sans TC', 'Arial', sans-serif;
    margin: 0;
    padding: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    user-select: none;
  }
  #inputArea { max-width: 480px; margin: 0 auto 24px; display: flex; gap: 16px; flex-wrap: wrap; align-items: center; justify-content: center; position: relative; padding: 0 8px;}
  #nameInput, #qtyInput, #addBtn {
    font-size: 1.3rem;
    border-radius: 10px;
    border: none;
    outline-offset: 2px;
    transition: box-shadow 0.2s ease;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }
  #nameInput {
    flex: 1 1 60%;
    padding: 14px 16px;
    background-color: #222;
    color: #fff;
    cursor: text;
    -webkit-user-select: text;
    user-select: text;
  }
  #nameInput:focus {
    box-shadow: 0 0 8px 3px #42a5f5;
    background-color: #333;
  }
  #autocomplete-list {
    position: absolute;
    top: 54px;
    left: 8px;
    right: calc(40% + 20px);
    max-height: 220px;
    overflow-y: auto;
    background: #222;
    border-radius: 0 0 10px 10px;
    border: 1px solid #555;
    z-index: 1000;
    display: none;
    user-select: none;
    -webkit-overflow-scrolling: touch;
  }
  #autocomplete-list div {
    padding: 14px 18px;
    cursor: pointer;
    color: #eee;
    font-size: 1.1rem;
    touch-action: manipulation;
  }
  #autocomplete-list div:hover, #autocomplete-list div.autocomplete-active {
    background-color: #444;
  }
  #qtyInput {
    flex: 1 1 20%;
    padding: 14px 16px;
    background-color: #222;
    color: #fff;
    cursor: pointer;
  }
  #qtyInput:focus {
    box-shadow: 0 0 8px 3px #42a5f5;
    background-color: #333;
  }
  #addBtn {
    flex: 1 1 18%;
    padding: 14px 0;
    background-color: #4caf50;
    color: white;
    font-weight: 700;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 6px 12px rgb(76 175 80 / 0.6);
    transition: background-color 0.3s ease;
    touch-action: manipulation;
    border-radius: 10px;
  }
  #addBtn:hover, #addBtn:focus {
    background-color: #45a049;
    outline: none;
  }
  #addBtn:active {
    background-color: #3b8e3a;
  }
  #captureArea {
    background: #222;
    color: #fff;
    padding: 24px 16px;
    border-radius: 14px;
    max-width: 480px;
    margin: 0 auto 24px;
    box-shadow: 0 0 24px rgba(0,0,0,0.8);
    user-select: text;
  }
  #captureArea h2 {
    text-align: center;
    margin-bottom: 20px;
    font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 1.2px;
    user-select: none;
  }
  #reportTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 1.1rem;
    table-layout: fixed;
    word-break: break-word;
  }
  #reportTable th, #reportTable td {
    border: 1px solid #555;
    padding: 12px 8px;
    text-align: center;
  }
  #reportTable thead {
    background: linear-gradient(90deg, #1e88e5, #42a5f5);
    color: #fff;
    font-weight: 700;
    letter-spacing: 0.1em;
  }
  #reportTable tfoot td {
    font-weight: 700;
    background-color: #111;
    color: #ccc;
    font-size: 1.15rem;
  }
  .deleteBtn {
    background-color: #e53935;
    border: none;
    color: white;
    border-radius: 10px;
    padding: 8px 18px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    font-size: 1rem;
    user-select: none;
    touch-action: manipulation;
  }
  .deleteBtn:hover, .deleteBtn:focus {
    background-color: #c62828;
    outline: none;
  }
  .deleteBtn:active {
    background-color: #9b1f1f;
  }
  #exportBtn {
    margin: 0 auto;
    display: block;
    padding: 18px 32px;
    font-size: 1.3rem;
    background: #4caf50;
    color: white;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    letter-spacing: 0.04em;
    box-shadow: 0 8px 16px rgb(76 175 80 / 0.7);
    user-select: none;
    max-width: 480px;
    touch-action: manipulation;
  }
  #exportBtn:hover, #exportBtn:focus {
    background: #45a049;
    outline: none;
  }
  #exportBtn:active {
    background: #3b8e3a;
  }
  @media (max-width: 480px) {
    #inputArea {
      padding: 0 12px;
      gap: 14px;
    }
    #nameInput, #qtyInput, #addBtn {
      font-size: 1.4rem;
      padding: 16px 20px;
      border-radius: 12px;
    }
    #exportBtn {
      font-size: 1.4rem;
      padding: 20px 36px;
    }
    #autocomplete-list {
      right: calc(40% + 24px);
      max-height: 240px;
    }
  }
</style>
</head>
<body>

  <div id="inputArea" role="combobox" aria-haspopup="listbox" aria-owns="autocomplete-list" aria-expanded="false">
    <input id="nameInput" type="text" placeholder="品項名稱 (輸入或選擇)" aria-autocomplete="list" aria-controls="autocomplete-list" autocomplete="off" aria-label="品項名稱" />
    <select id="qtyInput" aria-label="數量"></select>
    <button id="addBtn" aria-label="新增品項">新增品項</button>
    <div id="autocomplete-list" role="listbox" tabindex="-1"></div>
  </div>

  <div id="captureArea" aria-live="polite" aria-atomic="true" aria-relevant="all">
    <h2>🧾 品項報表</h2>
    <table id="reportTable" aria-label="品項報表">
      <thead>
        <tr>
          <th scope="col">品項名稱</th>
          <th scope="col">數量</th>
          <th scope="col">單價</th>
          <th scope="col">PV</th>
          <th scope="col">小計(元)</th>
          <th scope="col">刪除</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="3" style="text-align:right;">總 PV：</td>
          <td id="totalPv" colspan="3" style="text-align:left; font-weight:bold; font-size:1.3rem;">0</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <button id="exportBtn" aria-label="匯出報表為圖片">匯出報表為圖片</button>

<script>
  // 品項資料
  const items = [
    { name: "白金A", price: 2500, pv: 1000 },
    { name: "白金B", price: 1700, pv: 500 },
    { name: "白金C", price: 680, pv: 300 },
    { name: "白金D", price: 350, pv: 130 },
    { name: "白金E", price: 250, pv: 90 },
    { name: "白金F", price: 130, pv: 50 },
    { name: "葉綠素1瓶", price: 2000, pv: 0 },
    { name: "葉綠素2瓶", price: 4000, pv: 0 },
    { name: "葉綠素3瓶", price: 6000, pv: 0 },
    { name: "黑金G", price: 20000, pv: 6000 },
    { name: "黑金H", price: 12000, pv: 3600 },
    { name: "黑金I", price: 8000, pv: 2000 },
    { name: "黑金J", price: 3500, pv: 1000 },
  ];

  // UI 元素
  const nameInput = document.getElementById("nameInput");
  const qtyInput = document.getElementById("qtyInput");
  const addBtn = document.getElementById("addBtn");
  const autocompleteList = document.getElementById("autocomplete-list");
  const reportTableBody = document.querySelector("#reportTable tbody");
  const totalPv = document.getElementById("totalPv");
  const exportBtn = document.getElementById("exportBtn");
  const captureArea = document.getElementById("captureArea");
  const inputArea = document.getElementById("inputArea");

  let reportItems = [];

  // 初始化數量下拉選單 1~100
  function initQtyOptions() {
    for(let i=1; i<=100; i++) {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = i;
      qtyInput.appendChild(option);
    }
  }
  initQtyOptions();

  // 自動完成邏輯
  function closeAutocomplete() {
    autocompleteList.style.display = "none";
    inputArea.setAttribute("aria-expanded", "false");
  }
  function openAutocomplete() {
    if(autocompleteList.children.length > 0) {
      autocompleteList.style.display = "block";
      inputArea.setAttribute("aria-expanded", "true");
    } else {
      closeAutocomplete();
    }
  }

  function filterItems(val) {
    const filter = val.trim().toLowerCase();
    if(filter === "") return [];
    return items.filter(item => item.name.toLowerCase().includes(filter));
  }

  function renderAutocomplete(matches) {
    autocompleteList.innerHTML = "";
    if(matches.length === 0) {
      closeAutocomplete();
      return;
    }
    matches.forEach((item, index) => {
      const div = document.createElement("div");
      div.textContent = item.name;
      div.setAttribute("role", "option");
      div.id = `autocomplete-item-${index}`;
      div.tabIndex = -1;
      div.addEventListener("mousedown", (e) => {
        // mousedown優先於blur
        e.preventDefault();
        nameInput.value = item.name;
        closeAutocomplete();
        qtyInput.focus();
      });
      autocompleteList.appendChild(div);
    });
    openAutocomplete();
  }

  nameInput.addEventListener("input", () => {
    const val = nameInput.value;
    const matches = filterItems(val);
    renderAutocomplete(matches);
  });

  // 鍵盤上下選擇 autocomplete list
  let currentFocus = -1;
  nameInput.addEventListener("keydown", (e) => {
    const itemsList = autocompleteList.children;
    if(autocompleteList.style.display === "block") {
      if(e.key === "ArrowDown") {
        e.preventDefault();
        currentFocus++;
        if(currentFocus >= itemsList.length) currentFocus = 0;
        setActive(itemsList);
      } else if(e.key === "ArrowUp") {
        e.preventDefault();
        currentFocus--;
        if(currentFocus < 0) currentFocus = itemsList.length - 1;
        setActive(itemsList);
      } else if(e.key === "Enter") {
        e.preventDefault();
        if(currentFocus > -1) {
          itemsList[currentFocus].dispatchEvent(new Event("mousedown"));
          currentFocus = -1;
        } else {
          // 沒選擇 autocomplete 直接按 Enter，加品項
          addItem();
        }
        closeAutocomplete();
      } else if(e.key === "Escape") {
        closeAutocomplete();
      }
    } else {
      if(e.key === "Enter") {
        e.preventDefault();
        addItem();
      }
    }
  });

  function setActive(itemsList) {
    for(let i=0; i<itemsList.length; i++) {
      itemsList[i].classList.remove("autocomplete-active");
    }
    if(currentFocus >= 0 && currentFocus < itemsList.length) {
      itemsList[currentFocus].classList.add("autocomplete-active");
      itemsList[currentFocus].scrollIntoView({block: "nearest"});
    }
  }

  // 點擊外部關閉自動完成
  document.addEventListener("click", (e) => {
    if(!inputArea.contains(e.target)) {
      closeAutocomplete();
    }
  });

  // 新增品項
  function addItem() {
    const itemName = nameInput.value.trim();
    const qty = parseInt(qtyInput.value);

    if(itemName === "") {
      alert("請輸入品項名稱");
      nameInput.focus();
      return;
    }
    if(isNaN(qty) || qty < 1) {
      alert("請選擇數量");
      qtyInput.focus();
      return;
    }
    // 查找品項是否存在
    const item = items.find(i => i.name === itemName);
    if(!item) {
      alert("品項名稱錯誤或不存在");
      nameInput.focus();
      return;
    }

    // 是否已經有此品項，有的話疊加數量
    const existIndex = reportItems.findIndex(i => i.name === itemName);
    if(existIndex > -1) {
      reportItems[existIndex].qty += qty;
    } else {
      reportItems.push({ name: item.name, qty, price: item.price, pv: item.pv });
    }

    renderReport();

    // 清空輸入欄位
    nameInput.value = "";
    qtyInput.value = 1;
    nameInput.focus();
  }

  addBtn.addEventListener("click", addItem);

  // 渲染報表表格
  function renderReport() {
    reportTableBody.innerHTML = "";
    let sumPv = 0;

    for(let i=0; i<reportItems.length; i++) {
      const row = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = reportItems[i].name;
      row.appendChild(tdName);

      const tdQty = document.createElement("td");
      tdQty.textContent = reportItems[i].qty;
      row.appendChild(tdQty);

      const tdPrice = document.createElement("td");
      tdPrice.textContent = reportItems[i].price.toLocaleString();
      row.appendChild(tdPrice);

      const tdPv = document.createElement("td");
      tdPv.textContent = reportItems[i].pv.toLocaleString();
      row.appendChild(tdPv);

      const tdSubtotal = document.createElement("td");
      const subtotal = reportItems[i].qty * reportItems[i].price;
      tdSubtotal.textContent = subtotal.toLocaleString();
      row.appendChild(tdSubtotal);

      // 累加 PV 總和 = qty * pv
      sumPv += reportItems[i].qty * reportItems[i].pv;

      // 刪除按鈕欄
      const tdDelete = document.createElement("td");
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "deleteBtn";
      deleteBtn.textContent = "刪除";
      deleteBtn.setAttribute("aria-label", `刪除品項 ${reportItems[i].name}`);
      deleteBtn.addEventListener("click", () => {
        reportItems.splice(i, 1);
        renderReport();
      });
      tdDelete.appendChild(deleteBtn);
      row.appendChild(tdDelete);

      reportTableBody.appendChild(row);
    }

    totalPv.textContent = sumPv.toLocaleString();
  }

  // 匯出報表為圖片
  exportBtn.addEventListener("click", () => {
    exportBtn.disabled = true;
    exportBtn.textContent = "匯出中...";
    html2canvas(captureArea, {backgroundColor: "#121212", scale: 2}).then(canvas => {
      const link = document.createElement("a");
      link.download = `品項報表_${new Date().toISOString().slice(0,10)}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
      exportBtn.disabled = false;
      exportBtn.textContent = "匯出報表為圖片";
    }).catch(() => {
      alert("匯出失敗，請稍後再試");
      exportBtn.disabled = false;
      exportBtn.textContent = "匯出報表為圖片";
    });
  });
</script>

</body>
</html>
